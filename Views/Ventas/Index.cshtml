@model IEnumerable<Sistema_Ferreteria.Models.Ventas.Venta>
@{
    ViewData["Title"] = "Punto de Venta (POS)";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var clientes = (IEnumerable<Sistema_Ferreteria.Models.Clientes.Cliente>)ViewBag.Clientes;
    var productos = (IEnumerable<Sistema_Ferreteria.Models.Inventario.Producto>)ViewBag.Productos;
    var categorias = productos.Select(p => p.Categoria?.Nombre ?? "General").Distinct().OrderBy(c => c).ToList();
}

<div class="content-with-cart">
    <!-- Panel Izquierdo: Catálogo de Productos -->
    <div class="catalog-panel">
        <div class="card-erp mb-3">
            <div class="card-body p-3">
                <div class="row g-2 align-items-center">
                    <div class="col-md-6">
                        <div class="search-wrap">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" id="posSearch" class="form-control-erp" placeholder="Buscar producto por nombre o código..." onkeyup="filterProducts()">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2 overflow-auto pb-1" id="categoryTabs">
                            <button class="btn btn-sm btn-outline-primary active filter-cat" data-cat="all">Todo</button>
                            @foreach (var cat in categorias)
                            {
                                <button class="btn btn-sm btn-outline-secondary filter-cat" data-cat="@cat">@cat</button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="product-grid p-0" id="posProductGrid">
            @foreach (var prod in productos)
            {
                <div class="product-card pos-item @(prod.StockBase <= 0 ? "opacity-75" : "")" 
                     data-name="@prod.Nombre.ToLower()" 
                     data-code="@prod.Codigo?.ToLower()"
                     data-cat="@(prod.Categoria?.Nombre ?? "General")">
                    <div class="product-card-body">
                        <div class="product-card-sku">@prod.Codigo</div>
                        <h5 class="product-card-title">@prod.Nombre</h5>
                        
                        <div class="info-item mt-2">
                            <span class="info-label">Stock:</span>
                            <span class="info-value @(prod.StockBase <= 5 ? "text-danger" : "")">@prod.StockBase.ToString("N0")</span>
                        </div>
                        
                        <div class="mt-3">
                            <label class="x-small fw-bold text-muted d-block mb-1">Presentación / Precio</label>
                            <select class="form-select form-select-sm sel-presentacion">
                                @foreach (var pres in prod.Presentaciones.Where(p => p.Estado))
                                {
                                    <option value="@pres.IdPresentacion" 
                                            data-factor="@pres.FactorConversion" 
                                            data-precio="@pres.PrecioVenta"
                                            data-nombre="@pres.NombrePresentacion">
                                        @pres.NombrePresentacion - C$ @pres.PrecioVenta.ToString("N2")
                                    </option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="product-card-footer">
                        @if (prod.StockBase > 0)
                        {
                            <button class="btn-erp-primary btn-sm w-100 justify-content-center btn-add-cart" 
                                    data-id="@prod.IdProducto" 
                                    data-name="@prod.Nombre"
                                    data-stock="@prod.StockBase">
                                <i class="bi bi-plus-lg"></i> Agregar
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-secondary w-100" disabled>Agotado</button>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Panel Derecho: Tique / Carrito (Sticky) -->
    <div class="cart-sidebar">
        <div class="card-erp border-primary border-top-4 shadow-lg mb-0 h-100 d-flex flex-column" style="min-height: calc(100vh - 130px);">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <span class="fw-bold"><i class="bi bi-receipt me-2"></i>Tique de Venta</span>
                <button class="btn btn-sm btn-outline-danger" onclick="clearCart()" title="Limpiar Carrito">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            
            <div class="card-body p-0 flex-grow-1 overflow-auto" id="cartItemsContainer" style="max-height: 400px;">
                <!-- Datos del Cliente -->
                <div class="p-3 border-bottom bg-light">
                    <label class="form-label x-small fw-bold text-uppercase text-muted mb-1">Cliente</label>
                    <div class="input-group input-group-sm">
                        <select id="selectCliente" class="form-select border-0 shadow-none">
                            <option value="">Consumidor Final</option>
                            @foreach (var c in clientes)
                            {
                                <option value="@c.IdCliente">@c.Nombre</option>
                            }
                        </select>
                        <button class="btn btn-white border-0" type="button" onclick="rapidoCrearCliente()">
                            <i class="bi bi-person-plus text-primary"></i>
                        </button>
                    </div>
                </div>

                <!-- Tabla de Items -->
                <table class="table table-sm table-borderless mb-0" id="tablaDetalle">
                    <thead class="bg-light x-small text-muted text-uppercase">
                        <tr>
                            <th class="ps-3">Art.</th>
                            <th class="text-center">Cant.</th>
                            <th class="text-end pe-3">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Items dinámicos -->
                    </tbody>
                </table>
                <div id="sinItemsAviso" class="text-center py-5 text-muted">
                    <i class="bi bi-cart3 display-6 d-block mb-2"></i>
                    <p class="small">Carrito vacío</p>
                </div>
            </div>

            <div class="card-footer bg-white p-3 border-top-0">
                <div class="mb-3">
                    <select id="selectTipoPago" class="form-select form-select-sm mb-2">
                        <option value="Contado">Pago al Contado</option>
                        <option value="Credito">Venta al Crédito</option>
                    </select>
                </div>

                <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted small">Subtotal:</span>
                    <span class="fw-bold" id="txtSubtotal">C$ 0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-3 pt-2 border-top">
                    <span class="h5 fw-bold mb-0">TOTAL:</span>
                    <span class="h5 fw-bold mb-0 text-primary" id="txtTotal">C$ 0.00</span>
                </div>

                <button class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow-sm mb-2" id="btnFinalizarVenta">
                    <i class="bi bi-check2-circle me-2"></i> FINALIZAR VENTA
                </button>
                
                <button class="btn btn-outline-secondary w-100 py-2 btn-sm" data-bs-toggle="modal" data-bs-target="#modalVentasRecientes">
                    <i class="bi bi-clock-history me-1"></i> Ventas Recientes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ventas Recientes -->
<div class="modal fade modal-erp" id="modalVentasRecientes" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Historial de Ventas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-erp mb-0">
                        <thead>
                            <tr>
                                <th>Folio / Fecha</th>
                                <th>Cliente / Tipo</th>
                                <th>Estado</th>
                                <th class="text-end">Total</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var v in Model)
                            {
                                var totalPagado = v.PagosVenta?.Sum(p => p.Monto) ?? 0;
                                var saldo = v.Total - totalPagado;
                                <tr class="@(v.Estado == "Anulada" ? "table-light text-muted" : "")">
                                    <td>
                                        <div class="fw-bold">@v.NumeroFactura</div>
                                        <small>@v.Fecha.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        <div>@(v.Cliente?.Nombre ?? "Consumidor Final")</div>
                                        <small class="text-muted">@v.TipoPago</small>
                                    </td>
                                    <td>
                                        @if (v.Estado == "Anulada") { <span class="badge-erp secondary">Anulada</span> }
                                        else if (saldo <= 0) { <span class="badge-erp success">Pagado</span> }
                                        else { <span class="badge-erp warning">Saldo: C$ @saldo.ToString("N2")</span> }
                                    </td>
                                    <td class="text-end fw-bold">C$ @v.Total.ToString("N2")</td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            @if (v.Estado != "Anulada")
                                            {
                                                @if (saldo > 0)
                                                {
                                                    <button class="btn btn-sm btn-outline-success btn-pagar-venta" data-id="@v.IdVenta" data-total="@saldo"><i class="bi bi-cash"></i></button>
                                                }
                                                <button class="btn btn-sm btn-outline-danger btn-anular-venta" data-id="@v.IdVenta"><i class="bi bi-x"></i></button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Pago (Igual que antes pero más pulido) -->
<div class="modal fade modal-erp" id="modalPagoVenta" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Confirmar Cobro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <span class="text-muted small">Monto a Recibir</span>
                    <h1 class="fw-bold text-primary display-5" id="pagoTotalLabel">C$ 0.00</h1>
                </div>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label small fw-bold">Importe Recibido</label>
                        <input type="number" id="pagoMonto" class="form-control form-control-lg text-center" step="0.01" style="font-size: 2rem; font-weight: 700;"/>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Método</label>
                        <select id="pagoMetodo" class="form-select">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Tarjeta">Tarjeta</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Comprobante</label>
                        <input type="text" id="pagoComp" class="form-control" placeholder="# Op." />
                    </div>
                    <div class="col-12 mt-4 text-center p-3 rounded-4" id="cambioResult" style="display:none; background: #f0f9ff;">
                        <span class="text-muted d-block small">Su cambio es de:</span>
                        <h2 class="text-primary fw-bold mb-0" id="pagoCambio">C$ 0.00</h2>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-link" data-bs-dismiss="modal">Seguir Vendiendo</button>
                <button type="button" class="btn btn-primary px-5 py-2 fw-bold" id="btnConfirmarCobro">CONFIRMAR PAGO</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let detalleVenta = [];
        const modalPago = new bootstrap.Modal(document.getElementById('modalPagoVenta'));

        function filterProducts() {
            const search = $('#posSearch').val().toLowerCase();
            const cat = $('.filter-cat.active').data('cat');
            
            $('.pos-item').each(function() {
                const name = $(this).data('name');
                const code = $(this).data('code');
                const itemCat = $(this).data('cat');
                
                const matchesSearch = name.includes(search) || code.includes(search);
                const matchesCat = cat === 'all' || itemCat === cat;
                
                $(this).toggle(matchesSearch && matchesCat);
            });
        }

        $('.filter-cat').click(function() {
             $('.filter-cat').removeClass('active btn-primary').addClass('btn-outline-secondary');
             $(this).addClass('active btn-primary').removeClass('btn-outline-secondary');
             filterProducts();
        });

        $(document).on('click', '.btn-add-cart', function() {
            const $card = $(this).closest('.product-card');
            const $sel = $card.find('.sel-presentacion option:selected');
            
            const item = {
                idProducto: $(this).data('id'),
                nombre: $(this).data('name'),
                idPresentacion: parseInt($card.find('.sel-presentacion').val()),
                nombrePres: $sel.data('nombre'),
                precio: parseFloat($sel.data('precio')),
                factor: parseFloat($sel.data('factor')),
                cantidad: 1,
                cantidadBase: parseFloat($sel.data('factor')),
                total: parseFloat($sel.data('precio')),
                stock: parseFloat($(this).data('stock'))
            };

            const existing = detalleVenta.find(d => d.idPresentacion === item.idPresentacion);
            if (existing) {
                if ((existing.cantidad + 1) * existing.factor > existing.stock) {
                    showNotification('Stock Insuficiente', 'No hay más unidades en inventario.', 'warning');
                    return;
                }
                existing.cantidad++;
                existing.cantidadBase = existing.cantidad * existing.factor;
                existing.total = existing.cantidad * existing.precio;
            } else {
                detalleVenta.push(item);
            }
            renderTabla();
        });

        function removeItem(i) {
            detalleVenta.splice(i, 1);
            renderTabla();
        }

        function clearCart() {
            if (detalleVenta.length === 0) return;
            showConfirm('Vaciar Carrito', '¿Está seguro de remover todos los artículos?', () => {
                detalleVenta = [];
                renderTabla();
            });
        }

        function updateQty(index, qty) {
            const item = detalleVenta[index];
            const newQty = parseFloat(qty);
            if (newQty <= 0) { removeItem(index); return; }
            
            if (newQty * item.factor > item.stock) {
                showNotification('Excede Stock', 'Disponible: ' + item.stock, 'warning');
                renderTabla();
                return;
            }
            item.cantidad = newQty;
            item.cantidadBase = item.cantidad * item.factor;
            item.total = item.cantidad * item.precio;
            renderTabla();
        }

        function renderTabla() {
            const $tbody = $('#tablaDetalle tbody');
            $tbody.empty();
            let total = 0;

            if (detalleVenta.length > 0) $('#sinItemsAviso').hide();
            else $('#sinItemsAviso').show();

            detalleVenta.forEach((item, index) => {
                total += item.total;
                $tbody.append(`
                    <tr class="border-bottom">
                        <td class="ps-3 py-3">
                            <div class="fw-bold small text-truncate" style="max-width: 150px;">${item.nombre}</div>
                            <div class="x-small text-muted">${item.nombrePres} • C$ ${item.precio.toFixed(2)}</div>
                        </td>
                        <td class="text-center py-3">
                            <input type="number" class="form-control form-control-sm text-center border-0 bg-light rounded-pill mx-auto" 
                                   value="${item.cantidad}" style="width: 60px;" 
                                   onchange="updateQty(${index}, this.value)">
                        </td>
                        <td class="text-end pe-3 py-3 fw-bold">
                            C$ ${item.total.toFixed(2)}
                            <i class="bi bi-x-circle text-danger ms-2" style="cursor:pointer" onclick="removeItem(${index})"></i>
                        </td>
                    </tr>
                `);
            });

            $('#txtSubtotal, #txtTotal').text('C$ ' + total.toLocaleString(undefined, { minimumFractionDigits:2 }));
            
            // Efecto visual en el total si cambia
            $('#txtTotal').addClass('total-amount');
        }

        $('#btnFinalizarVenta').click(function() {
            if (detalleVenta.length === 0) return;
            const total = detalleVenta.reduce((s, d) => s + d.total, 0);
            
            if ($('#selectTipoPago').val() === 'Contado') {
                $('#pagoTotalLabel').text('C$ ' + total.toLocaleString(undefined, { minimumFractionDigits:2 }));
                $('#pagoMonto').val(total);
                $('#cambioResult').hide();
                modalPago.show();
                setTimeout(() => $('#pagoMonto').focus().select(), 500);
            } else {
                showConfirm('Confirmar Crédito', '¿Registrar venta al crédito para este cliente?', () => procesarVenta(null));
            }
        });

        $('#pagoMonto').on('input', function() {
            const total = detalleVenta.reduce((s, d) => s + d.total, 0);
            const val = parseFloat($(this).val()) || 0;
            if (val > total) {
                $('#pagoCambio').text('C$ ' + (val - total).toLocaleString(undefined, { minimumFractionDigits:2 }));
                $('#cambioResult').show();
            } else $('#cambioResult').hide();
        });

        $('#btnConfirmarCobro').click(() => {
            const total = detalleVenta.reduce((s, d) => s + d.total, 0);
            const pago = { monto: total, metodo: $('#pagoMetodo').val(), comprobante: $('#pagoComp').val() };
            procesarVenta(pago);
        });

        async function procesarVenta(pagoInicial) {
            const data = {
                idCliente: $('#selectCliente').val() ? parseInt($('#selectCliente').val()) : null,
                tipoPago: $('#selectTipoPago').val(),
                detalles: detalleVenta.map(d => ({
                    idProducto: d.idProducto,
                    idPresentacion: d.idPresentacion,
                    cantidad: d.cantidad,
                    cantidadBase: d.cantidadBase,
                    precioUnitario: d.precio,
                    descuento: 0
                })),
                pagoInicial: pagoInicial
            };

            const $btn = $('#btnConfirmarCobro, #btnFinalizarVenta');
            $btn.prop('disabled', true).text('Guardando...');

            try {
                const res = await fetch('/Ventas/Crear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                if (json.success) {
                    showNotification('Venta Completada', 'Factura: ' + json.factura, 'success');
                    modalPago.hide();
                    setTimeout(() => location.reload(), 1000);
                } else showNotification('Error', json.message, 'error');
            } catch (e) { showNotification('Error', 'Fallo conexión servidor', 'error'); }
            $btn.prop('disabled', false);
        }

        async function rapidoCrearCliente() {
            const nombre = prompt('Escriba el nombre completo del cliente:');
            if (!nombre) return;
            const res = await fetch('/Ventas/CrearCliente', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, tipoDocumento: 'DNI', numeroDocumento: '000', estado: true })
            });
            const json = await res.json();
            if (json.success) {
                $('#selectCliente').append(`<option value="${json.id}">${nombre}</option>`).val(json.id);
                showNotification('Cliente Creado', 'Seleccionado automáticamente.', 'success');
            }
        }
        
        $(document).on('click', '.btn-anular-venta', function() {
            const id = $(this).data('id');
            showConfirm('¿Anular Factura?', 'El stock será devuelto y la deuda cancelada.', () => {
                const motivo = prompt('Motivo de anulación:');
                if(!motivo) return;
                $.post('/Ventas/Anular', { id, motivo }, res => {
                    if (res.success) location.reload(); else showNotification('Error', res.message, 'error');
                });
            }, 'danger');
        });

        $(document).on('click', '.btn-pagar-venta', function() {
             const id = $(this).data('id');
             const total = $(this).data('total');
             $('#pagoTotalLabel').text('C$ ' + parseFloat(total).toLocaleString(undefined, { minimumFractionDigits: 2 }));
             $('#pagoMonto').val(total);
             $('#btnConfirmarCobro').off('click').on('click', async () => {
                 const data = { idVenta: id, monto: $('#pagoMonto').val(), metodo: $('#pagoMetodo').val(), comprobante: $('#pagoComp').val() };
                 const res = await fetch('/Ventas/RegistrarPago', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                 const j = await res.json();
                 if (j.success) location.reload();
             });
             modalPago.show();
        });
    </script>
}
