@model IEnumerable<Sistema_Ferreteria.Models.Seguridad.Usuario>
@{
    ViewData["Title"] = "Gestión de Usuarios y Roles";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var roles = (IEnumerable<Sistema_Ferreteria.Models.Seguridad.Rol>)ViewBag.Roles;
    var permisos = (IEnumerable<Sistema_Ferreteria.Models.Seguridad.Permiso>)ViewBag.Permisos;
}

<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>Configuración de Seguridad</h1>
        <p class="subtitle">Administrar accesos, perfiles y permisos del sistema</p>
    </div>
</div>

<!-- Tabs Estilo Moderno -->
<ul class="nav nav-pills nav-erp-tabs mb-4" id="seguridadTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="usuarios-tab" data-bs-toggle="tab" data-bs-target="#usuariosPane" type="button" role="tab">
            <i class="bi bi-people me-2"></i> Usuarios
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="roles-tab" data-bs-toggle="tab" data-bs-target="#rolesPane" type="button" role="tab">
            <i class="bi bi-shield-check me-2"></i> Roles y Permisos
        </button>
    </li>
</ul>

<div class="tab-content" id="seguridadTabsContent">
    <!-- PANEL USUARIOS -->
    <div class="tab-pane fade show active" id="usuariosPane" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">Listado de Usuarios</h5>
            <button type="button" class="btn btn-primary" onclick="nuevoUsuario()">
                <i class="bi bi-person-plus me-1"></i> Nuevo Usuario
            </button>
        </div>

        <div class="card-erp">
            <div class="table-responsive">
                <table class="table table-hover table-erp align-middle">
                    <thead>
                        <tr>
                            <th>Nombre Completo</th>
                            <th>Usuario</th>
                            <th>Roles Asignados</th>
                            <th>Estado</th>
                            <th>Creación</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var u in Model)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle me-3">@u.Nombre.Substring(0, 1)</div>
                                        <span class="fw-bold">@u.Nombre</span>
                                    </div>
                                </td>
                                <td><code>@u.NombreUsuario</code></td>
                                <td>
                                    @foreach (var ur in u.UsuarioRoles)
                                    {
                                        <span class="badge bg-light text-dark border me-1">@ur.Rol.Nombre</span>
                                    }
                                </td>
                                <td>
                                    <span class="badge-erp @(u.Estado ? "success" : "danger")">
                                        @(u.Estado ? "Activo" : "Inactivo")
                                    </span>
                                </td>
                                <td class="small text-muted">@u.FechaCreacion.ToShortDateString()</td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick='editarUsuario(@Json.Serialize(u))'>
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="eliminarUsuario(@u.IdUsuario)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PANEL ROLES -->
    <div class="tab-pane fade" id="rolesPane" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">Configuración de Perfiles</h5>
            <button type="button" class="btn btn-primary" onclick="nuevoRol()">
                <i class="bi bi-shield-plus me-1"></i> Crear Nuevo Rol
            </button>
        </div>

        <div class="row g-4">
            @foreach (var r in roles)
            {
                <div class="col-md-6 col-xl-4">
                    <div class="card-erp h-100 shadow-sm transition-hover">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="role-icon-box bg-primary-subtle text-primary">
                                    <i class="bi bi-shield-lock"></i>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                    <ul class="dropdown-menu shadow">
                                        <li><a class="dropdown-item" href="#" onclick='editarRol(@Json.Serialize(r))'><i class="bi bi-pencil me-2"></i> Editar Rol</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-trash me-2"></i> Eliminar</a></li>
                                    </ul>
                                </div>
                            </div>
                            <h5 class="fw-bold">@r.Nombre</h5>
                            <p class="text-muted small mb-3">@r.Descripcion</p>
                            
                            <label class="small fw-bold text-uppercase text-muted d-block mb-2" style="font-size: 10px; letter-spacing: 1px;">Permisos Habilitados</label>
                            <div class="d-flex flex-wrap gap-1 mb-4">
                                @foreach (var rp in r.RolPermisos)
                                {
                                    <span class="badge bg-secondary-subtle text-secondary small border-0">@rp.Permiso.Nombre</span>
                                }
                                @if (!r.RolPermisos.Any())
                                {
                                    <span class="text-muted small italic">Sin permisos asignados</span>
                                }
                            </div>
                            
                            <button class="btn btn-sm btn-outline-primary w-100" onclick='editarRol(@Json.Serialize(r))'>
                                <i class="bi bi-gear me-1"></i> Configurar Permisos
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- MODAL USUARIO -->
<div class="modal fade" id="modalUsuario" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-bottom-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" id="tituloModalUsuario">Nuevo Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="formUsuario">
                    <input type="hidden" id="userId" value="0" />
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Nombre Completo</label>
                        <input type="text" id="userNombre" class="form-control-erp" required />
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">Usuario</label>
                            <input type="text" id="userLogin" class="form-control-erp" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">Contraseña</label>
                            <input type="password" id="userPass" class="form-control-erp" placeholder="Dejar vacío para no cambiar" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold d-block">Roles Asignados</label>
                        <div class="d-flex flex-wrap gap-3">
                            @foreach (var r in roles)
                            {
                                <div class="form-check">
                                    <input class="form-check-input check-rol" type="checkbox" value="@r.IdRol" id="chkRol_@r.IdRol">
                                    <label class="form-check-label small" for="chkRol_@r.IdRol">@r.Nombre</label>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="form-check form-switch mt-4">
                        <input class="form-check-input" type="checkbox" id="userEstado" checked>
                        <label class="form-check-label" for="userEstado">Usuario Activo</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top-0 pb-4 px-4">
                <button type="button" class="btn-erp-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary px-4" onclick="guardarUsuario()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL ROL -->
<div class="modal fade" id="modalRol" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-bottom-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" id="tituloModalRol">Nuevo Rol</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="formRol">
                    <input type="hidden" id="rolId" value="0" />
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">Nombre del Rol</label>
                            <input type="text" id="rolNombre" class="form-control-erp" placeholder="Ej: Vendedor de Piso" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold">Descripción</label>
                            <input type="text" id="rolDesc" class="form-control-erp" placeholder="Gestión de ventas y caja..." />
                        </div>
                    </div>
                    <hr class="my-4 text-muted opacity-25">
                    <h6 class="fw-bold mb-3 d-flex align-items-center">
                        <i class="bi bi-key me-2 text-primary"></i> Asignar Permisos Dinámicos
                    </h6>
                    <div class="row g-3">
                        @foreach (var m in permisos.GroupBy(p => p.Modulo))
                        {
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded-3 h-100">
                                    <h6 class="small fw-bold text-primary text-uppercase mb-2">@m.Key</h6>
                                    @foreach (var p in m)
                                    {
                                        <div class="form-check mb-1">
                                            <input class="form-check-input check-permiso" type="checkbox" value="@p.IdPermiso" id="chkP_@p.IdPermiso">
                                            <label class="form-check-label small" for="chkP_@p.IdPermiso" title="@p.Descripcion">@p.Nombre</label>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top-0 pb-4 px-4">
                <button type="button" class="btn-erp-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary px-4" onclick="guardarRol()">Guardar Rol</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const modalUser = new bootstrap.Modal(document.getElementById('modalUsuario'));
        const modalRol = new bootstrap.Modal(document.getElementById('modalRol'));

        function nuevoUsuario() {
            document.getElementById('tituloModalUsuario').innerText = 'Nuevo Usuario';
            document.getElementById('userId').value = 0;
            document.getElementById('formUsuario').reset();
            $('.check-rol').prop('checked', false);
            modalUser.show();
        }

        function editarUsuario(u) {
            document.getElementById('tituloModalUsuario').innerText = 'Editar Usuario';
            document.getElementById('userId').value = u.idUsuario;
            document.getElementById('userNombre').value = u.nombre;
            document.getElementById('userLogin').value = u.nombreUsuario;
            document.getElementById('userPass').value = '';
            document.getElementById('userEstado').checked = u.estado;

            $('.check-rol').prop('checked', false);
            u.usuarioRoles.forEach(ur => {
                $('#chkRol_' + ur.idRol).prop('checked', true);
            });
            modalUser.show();
        }

        async function guardarUsuario() {
            const rolesIds = [];
            $('.check-rol:checked').each(function() { rolesIds.push(parseInt($(this).val())); });

            const data = {
                idUsuario: parseInt($('#userId').val()),
                nombre: $('#userNombre').val(),
                nombreUsuario: $('#userLogin').val(),
                contraseñaHash: $('#userPass').val(),
                estado: $('#userEstado').is(':checked')
            };

            const resp = await fetch(`/Usuarios/GuardarUsuario?${rolesIds.map(x => "rolesIds="+x).join("&")}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const res = await resp.json();
            if(res.success) { showNotification('Éxito', res.message, 'success'); setTimeout(() => location.reload(), 800); }
            else { showNotification('Error', res.message, 'error'); }
        }

        function nuevoRol() {
            document.getElementById('tituloModalRol').innerText = 'Nuevo Rol';
            document.getElementById('rolId').value = 0;
            document.getElementById('formRol').reset();
            $('.check-permiso').prop('checked', false);
            modalRol.show();
        }

        function editarRol(r) {
            document.getElementById('tituloModalRol').innerText = 'Configurar Rol: ' + r.nombre;
            document.getElementById('rolId').value = r.idRol;
            document.getElementById('rolNombre').value = r.nombre;
            document.getElementById('rolDesc').value = r.descripcion;
            
            $('.check-permiso').prop('checked', false);
            r.rolPermisos.forEach(rp => {
                $('#chkP_' + rp.idPermiso).prop('checked', true);
            });
            modalRol.show();
        }

        async function guardarRol() {
            const pIds = [];
            $('.check-permiso:checked').each(function() { pIds.push(parseInt($(this).val())); });

            const data = {
                idRol: parseInt($('#rolId').val()),
                nombre: $('#rolNombre').val(),
                descripcion: $('#rolDesc').val(),
                estado: true
            };

            const resp = await fetch(`/Usuarios/GuardarRol?${pIds.map(x => "permisosIds="+x).join("&")}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const res = await resp.json();
            if(res.success) { showNotification('Éxito', res.message, 'success'); setTimeout(() => location.reload(), 800); }
            else { showNotification('Error', res.message, 'error'); }
        }

        async function eliminarUsuario(id) {
            showConfirm('¿Eliminar Usuario?', 'Se marcará al usuario como eliminado y ya no podrá acceder al sistema.', async () => {
                const resp = await fetch(`/Usuarios/EliminarUsuario/${id}`, { method: 'POST' });
                const res = await resp.json();
                if(res.success) location.reload();
            });
        }
    </script>
}

<style>
    .avatar-circle {
        width: 35px;
        height: 35px;
        background: #3e97ff;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
    }
    .nav-erp-tabs .nav-link {
        border-radius: 12px;
        padding: 10px 20px;
        font-weight: 500;
        color: #7e8299;
        transition: all 0.3s;
    }
    .nav-erp-tabs .nav-link.active {
        background: #3e97ff;
        color: #fff;
        box-shadow: 0 4px 10px rgba(62, 151, 255, 0.3);
    }
    .role-icon-box {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }
    .transition-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
</style>
